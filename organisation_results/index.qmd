---
title: "Organisation results"
subtitle: |
    An overview of Civil Service People Survey results by organisation
execute: 
  echo: false
format:
    html: 
        fig-cap-location: top
---

Each year around 100 government departments, agencies and other UK Civil Service
organisations take part in the People Survey each year[^organisation]. This
page provides a summary of all organisation scores as well as a focus on the
results of the main departments, use the drop-down below to view the results
for a particular organisation.

[^organisation]: Add organisation definition note.

```{r}
htmltools::includeHTML("../partials/org_select/org_select_2024.html")
htmltools::includeScript("../partials/org_select/org_select_year.js")
```

## All organisations

Across all most all questions and measures in the People Survey there is
substantial variation in organisation scores. In 2024 the range of organisation
scores for the headline engagement index ranged from 52% to 80.5%.

```{r}
#| column: page-inset-right
#| label: fig-org-summary
#| fig-cap-location: top
#| fig-cap: Summary of organisation scores for the engagement index and
#|   theme scores 2009-2024
library(ggplot2)

csps_orgs <- arrow::read_parquet(
    "~/code/csps-data/data/02-organisations/csps_organisations_2009-2024_df950add.parquet"
)

pctls <- function(df) {
    x <- quantile(df$value, probs = c(0, 0.25, 0.5, 0.75, 1))
    names(x) <- gsub("(\\d+).*", "p\\1", names(x))
    tibble::as_tibble(as.list(x))
}

csps_org_ee_summary <- csps_orgs |>
    dplyr::arrange(year, uid_qm_num, uid_org_txt) |>
    dplyr::filter(grepl("^1", uid_qm_num)) |>
    tidyr::nest(data = c(uid_org_txt, value), .by = c(year, uid_qm_num, uid_qm_txt)) |>
    dplyr::mutate(
        pctls = purrr::map(
            .x = data,
            .f = pctls
        )
    ) |>
    dplyr::select(year, uid_qm_num, uid_qm_txt, pctls) |>
    tidyr::unnest_wider(pctls) |>
    dplyr::mutate(
        txt_label = dplyr::case_match(
            uid_qm_txt,
            "000.engagement_index" ~ "Engagement index",
            "000.my_work" ~ "My work",
            "000.objectives_purpose" ~ "Organisational objectives and purpose",
            "000.my_manager" ~ "My manager",
            "000.my_team" ~ "My team",
            "000.learning_development" ~ "Learning and development",
            "000.inclusion_treatment" ~ "Inclusion and fair treatment",
            "000.resources_workload" ~ "Resources and workload",
            "000.pay_benefits" ~ "Pay and benefits",
            "000.leadership_change" ~ "Leadership and managing change"
        ),
        txt_label = stringr::str_wrap(txt_label, 12),
        txt_label = forcats::fct_inorder(txt_label)
    )

summary_plot <- ggplot(csps_org_ee_summary, aes(x = year, group = uid_qm_txt)) +
    geom_ribbon(aes(ymin = p0, ymax = p100, fill = "full"), alpha = 0.5, key_glyph = "point") +
    geom_ribbon(aes(ymin = p25, ymax = p75, fill = "iqr"), alpha = 0.5, key_glyph = "point") +
    geom_line(aes(y = p0), linewidth = 0.25, alpha = 0.5, colour = "#1192e8") +
    geom_line(aes(y = p25), linewidth = 0.25, alpha = 0.5, colour = "#1192e8") +
    geom_line(aes(y = p75), linewidth = 0.25, alpha = 0.5, colour = "#1192e8") +
    geom_line(aes(y = p100), linewidth = 0.25, alpha = 0.5, colour = "#1192e8") +
    geom_line(aes(y = p50, colour = "benchmark"), linewidth = 0.75) +
    geom_point(
        data = dplyr::filter(csps_org_ee_summary, year == 2024),
        mapping = aes(x = year, y = p50, colour = "latest")
    ) +
    scale_fill_manual(
        values = c(
            "full" = "#bae6ff",
            "iqr" = "#82cfff"
        ),
        labels = c(
            "full" = "Highest and lowest organisation scores each year",
            "iqr" = "Upper and lower quartile of organisation scores each year"
        ),
        guide = guide_legend(
            title = NULL, position = "bottom", ncol = 1, order = 2,
            override.aes = list(shape = 22, size = 5, colour = "#1192e8", stroke = 0.5)
        )
    ) +
    scale_colour_manual(
        values = c(
            "benchmark" = "#1192e8",
            "latest" = "#1192e8"
        ),
        labels = c(
            "benchmark" = "Civil Service benchmark score (median organisation score)",
            "latest" = "Latest year's benchmark score"
        ),
        guide = guide_legend(title = NULL, position = "bottom", ncol = 1, order = 1)
    ) +
    scale_x_continuous(
        breaks = seq(2009, 2024, 5),
        expand = expansion(add = 0.5)
    ) +
    scale_y_continuous(
        limits = c(0, 100),
        breaks = seq(0, 100, 10),
        labels = scales::label_percent(scale = 1),
        expand = expansion(add = 2)
    ) +
    labs(y = NULL, x = NULL) +
    facet_wrap(vars(txt_label), nrow = 1) +
    theme_minimal() +
    theme(
        text = element_text(family = "IBM Plex Sans", size = 9, colour = "#393939"),
        axis.text = element_text(size = 9, colour = "#393939"),
        strip.text = element_text(size = 9, colour = "#393939"),
        panel.grid.major = element_line(colour = "#e0e0e0", linewidth = 0.25),
        panel.grid.minor = element_blank(),
        panel.spacing.x = unit(12, "pt"),
        axis.text.x = element_text(angle = 90, size = 8),
        axis.title.x.bottom = element_text(margin = margin(t = 6, b = 3)),
        axis.title.y.left = element_text(margin = margin(l = 3, r = 6)),
        legend.text = element_text(size = 9, color = "#393939")
    )

inlinesvg::inline_svg_plot(
    summary_plot, width = 1000, height = 600,
    web_fonts = svglite::fonts_as_import("IBM Plex Sans")
)

```


```{r}
#| column: page-inset-right
#| label: fig-org-diff
#| fig-cap-location: top
#| fig-cap: Summary of changes in organisation scores for the engagement index
#|   and theme scores from 2023 to 2024
org_diff <- csps_orgs |>
    dplyr::filter(grepl("^1", uid_qm_num) & (year == 2024 | year == 2023)) |>
    dplyr::mutate(
        # rename LEVLUP to HSCMLG
        uid_org_txt = dplyr::if_else(uid_org_txt == "LEVLUP", "HSCMLG", uid_org_txt),
        year = paste0("yr_", year)
    ) |>
    tidyr::pivot_wider(names_from = year, values_from = value) |>
    dplyr::mutate(
        diff = yr_2024 - yr_2023,
        txt_label = dplyr::case_match(
            uid_qm_txt,
            "000.engagement_index" ~ "Engagement index",
            "000.my_work" ~ "My work",
            "000.objectives_purpose" ~ "Organisational objectives and purpose",
            "000.my_manager" ~ "My manager",
            "000.my_team" ~ "My team",
            "000.learning_development" ~ "Learning and development",
            "000.inclusion_treatment" ~ "Inclusion and fair treatment",
            "000.resources_workload" ~ "Resources and workload",
            "000.pay_benefits" ~ "Pay and benefits",
            "000.leadership_change" ~ "Leadership and managing change"
        ),
        txt_label = stringr::str_wrap(txt_label, 20),
        txt_label = forcats::fct_inorder(txt_label)
    )

diff_plot <- ggplot(dplyr::filter(org_diff, !(diff > 10 | diff < -10))) +
    geom_segment(
        aes(x = 0, y = yr_2023, xend = diff, yend = yr_2024, colour = diff, group = uid_org_txt),
        alpha = 0.5, arrow = arrow(length = unit(3, "pt"))
    ) +
    geom_vline(xintercept = 0, colour = "#a8a8a8", linewidth = 0.25) +
    # tidytext::scale_y_reordered(
    #     labels = NULL
    # ) +
    labs(
        y = "Score", x = "\nChange in score 2023 to 2024"
    ) +
    scale_color_gradient2(
        low = "#0072c3",
        mid = "#cac5c4",
        high = "#eb6200",
        guide = guide_colorsteps(title = "Change in score")
    ) +
    scale_y_continuous(
        limits = c(0, 100),
        labels = scales::label_percent(scale = 1)
    ) +
    scale_x_continuous(
        limits = c(-10, 10),
        labels = scales::label_number(style_positive = "plus")
    ) +
    coord_fixed(ratio = 0.2) +
    facet_wrap(vars(txt_label), nrow = 2) +
    theme_minimal() +
    theme(
        text = element_text(family = "IBM Plex Sans", size = 9, colour = "#393939"),
        axis.text = element_text(size = 9, color = "#393939"),
        strip.text = element_text(size = 9, color = "#393939"),
        panel.grid.major = element_line(colour = "#e0e0e0", linewidth = 0.25),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(margin = margin(t = 6, b = 3)),
        axis.title.y = element_text(margin = margin(l = 3, r = 6)),
        legend.position = "none"
    )

inlinesvg::inline_svg_plot(
    diff_plot, width = 1000, height = 500,
    web_fonts = svglite::fonts_as_import("IBM Plex Sans")
)
```

## Main departments

This section reviews the results for the XX main Whitehall departments.

.
