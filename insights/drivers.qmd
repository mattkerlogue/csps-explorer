---
draft: true
---
# Drivers of employee engagement

...

```{r}

# csps_orgs <- arrow::read_parquet("../csps-data/data/02-organisations/csps_organisations_2009-2024_df950add.parquet")

# # model using published scores results in correlation issues
# #
# # drivers_all <- csps_orgs |>
# #   dplyr::filter(grepl("^1\\.", uid_qm_num)) |>
# #   dplyr::select(uid_org_txt, year, name = uid_qm_txt, value) |>
# #   dplyr::mutate(name = gsub("^000\\.", "", name)) |>
# #   tidyr::pivot_wider(names_from = name, values_from = value)

# # da_model <- lm(
# #   engagement_index ~ my_work + objectives_purpose + my_manager + my_team +
# #     learning_development + inclusion_treatment + resources_workload +
# #     pay_benefits + leadership_change,
# #   data = drivers_all
# # )

# # summary(da_model)

# qm_input <- csps_orgs |>
#   dplyr::add_count(uid_org_txt, uid_qm_num) |>
#   dplyr::filter(n == 16 & grepl("^2", uid_qm_num)) |>
#   dplyr::select(uid_org_txt, year, name = uid_qm_txt, value) |>
#   tidyr::pivot_wider(names_from = name, values_from = value)


# # confirm ee distinct concept
# set.seed(20251712)

# ee_fa_model <- fa_model <- factanal(
#   x = dplyr::select(qm_input, where(is.numeric), -year),
#   factors = 9,
#   scores = "Bartlett", rotation = "varimax"
# )

# psych::alpha(
#   qm_input |> dplyr::select(starts_with("eng"))
# )

# # driver model

# set.seed(20251712)

# qm_input_excl_ee <- qm_input |>
#   dplyr::select(-starts_with("eng"), -starts_with("act"))

# fa_model <- factanal(
#   x = dplyr::select(qm_input_excl_ee, where(is.numeric), -year),
#   factors = 7,
#   scores = "Bartlett", rotation = "varimax"
# )

# fa_scores <- tibble::as_tibble(fa_model$scores, .name_repair = "unique_quiet") |>
#   dplyr::bind_cols(qm_input |> dplyr::select(uid_org_txt, year)) |>
#   dplyr::left_join(
#     csps_orgs |> 
#       dplyr::filter(uid_qm_txt == "000.engagement_index") |>
#       dplyr::select(uid_org_txt, year, engagement_index = value),
#     by = c("uid_org_txt", "year")
#   ) |>
#   dplyr::select(
#     uid_org_txt, 
#     year,
#     engagement_index,
#     f1_manager = Factor1,
#     f2_leadership = Factor2,
#     f3_mywork = Factor3,
#     f4_objectives = Factor4,
#     f5_pay = Factor5,
#     f6_workload = Factor6,
#     f7_learning = Factor7,
#     f8_fairness = Factor8,
#     f9_resources = Factor9
#   )

# drivers_fa <- lm(
#   engagement_index ~ f1_manager + f2_leadership + f3_mywork +
#     f4_objectives + f5_pay + f6_workload + f7_learning + f8_fairness +
#     f9_resources,
#   data = fa_scores
# )

# drivers_beta <- lm.beta::lm.beta(drivers_fa)

# fa_scores_change <- fa_scores |>
#   tidyr::pivot_longer(cols = c(-uid_org_txt, -year)) |>
#   dplyr::arrange(uid_org_txt, name, year) |>
#   dplyr::mutate(
#     change = value - dplyr::lag(value),
#     .by = c(uid_org_txt, name)
#   ) |>
#   dplyr::filter(!is.na(change)) |>
#   dplyr::select(-value) |>
#   tidyr::pivot_wider(names_from = name, values_from = change)

# drivers_fa_change <- lm(
#   engagement_index ~ f1_manager + f2_leadership + f3_mywork +
#     f4_objectives + f5_pay + f6_workload + f7_learning + f8_fairness +
#     f9_resources,
#   data = fa_scores_change
# )

# drivers_fa_change_beta <- lm.beta::lm.beta(drivers_fa_change)

```